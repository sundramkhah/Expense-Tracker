<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pro Expense Tracker — Advanced</title>

  <!-- Google Fonts + Font Awesome + Chart.js -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a2d9f6c9b1.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  
    :root{
      --bg: #f4f7fb;
      --card: #ffffff;
      --muted: #7b8794;
      --accent: linear-gradient(135deg,#4db6ac,#0288d1);
      --primary: #0288d1;
      --success: #43a047;
      --danger: #e53935;
      --glass: rgba(255,255,255,0.6);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: 'Inter', system-ui, Arial;
      background: radial-gradient(1200px 600px at -10% -20%, rgba(2,136,209,0.06), transparent),
                  radial-gradient(900px 500px at 110% 120%, rgba(76,175,80,0.03), transparent),
                  var(--bg);
      color:#0f1720;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:18px;
    }

    /* Top bar */
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px;
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:52px;height:52px;border-radius:12px;
      background:linear-gradient(135deg,#00796b,#0288d1);
      display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px;
      box-shadow:0 6px 18px rgba(2,136,209,0.08);
    }
    .title{font-size:18px;font-weight:700}
    .actions{display:flex;gap:8px;align-items:center}

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      align-items:start;
    }

    /* Left column */
    .panel{
      background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 24px rgba(8,20,30,0.04);
    }

    .card{
      margin-bottom:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.4));
      border:1px solid rgba(0,0,0,0.03);
    }

    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"], input[type="number"], input[type="date"], select, textarea{
      width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef3;background:white;font-size:14px;
    }
    textarea{min-height:70px;resize:vertical}

    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn-primary{background:linear-gradient(90deg,#0288d1,#0288d1);color:white}
    .btn-ghost{background:transparent;border:1px solid #e6eef3}
    .small{font-size:13px;padding:6px 8px}

    .summary{
      display:grid;grid-template-columns:1fr 1fr;gap:10px;
    }
    .stat{
      display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;background:linear-gradient(90deg,#fff, #fafafa);
      box-shadow:inset 0 -1px 0 rgba(0,0,0,0.02);
    }
    .stat .icon{width:44px;height:44;border-radius:10px;display:flex;align-items:center;justify-content:center;color:white}
    .stat .num{font-weight:700;font-size:18px}
    .stat .lbl{font-size:12px;color:var(--muted)}

    /* Right column */
    .dashboard{
      display:flex;flex-direction:column;gap:12px;
    }

    .charts{display:grid;grid-template-columns:1fr 420px;gap:12px}
    canvas{background:transparent;border-radius:8px}

    /* Table */
    .table{width:100%;border-collapse:collapse;margin-top:8px}
    .table th, .table td{padding:10px;text-align:left;border-bottom:1px solid #f0f3f6}
    .table th{font-size:13px;padding:12px 10px;background:#0b69a3;color:white;border-radius:6px 6px 0 0}
    .txn-row .badge{display:inline-block;padding:5px 8px;border-radius:999px;font-size:12px}
    .txn-actions button{margin-right:6px}

    /* Search & filters */
    .filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .filters input[type="search"]{min-width:160px;padding:8px;border-radius:8px;border:1px solid #e6eef3}

    /* Budget */
    .progress{height:12px;background:#f1f5f9;border-radius:10px;overflow:hidden}
    .progress .bar{height:100%;background:linear-gradient(90deg,#f59e0b,#ef4444);width:0}

    /* Recent list */
    .recent-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f1f5f9}
    .muted{color:var(--muted)}

    /* Login modal */
    .modal{
      position:fixed;left:0;right:0;top:0;bottom:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.45);
    }
    .modal-card{width:420px;background:var(--card);padding:20px;border-radius:12px;box-shadow:0 18px 40px rgba(2,6,23,0.3);}

    /* Toast */
    .toast{position:fixed;right:18px;bottom:18px;background:#0f1720;color:white;padding:12px 16px;border-radius:10px;box-shadow:0 8px 24px rgba(2,6,23,0.18);display:none}
    .toast.show{display:block}

    /* Responsive */
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr; padding-bottom:24px}
      .charts{grid-template-columns:1fr; }
      .panel{order:2}
    }
  
</style>
  
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo">EX</div>
      <div>
        <div class="title">Pro Expense Tracker</div>
        <div class="muted" style="font-size:13px">Smart budgeting & expense insights</div>
      </div>
    </div>

    <div class="actions">
      <button id="btn-theme" class="btn btn-ghost small"><i class="fa-regular fa-moon"></i>&nbsp;Theme</button>
      <div id="user-area"></div>
    </div>
  </div>

  <div class="layout">
    <!-- left -->
    <div class="panel">
      <!-- Add / Edit -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div><strong id="form-title">Add Transaction</strong><div class="muted" style="font-size:12px">Quickly add income & expenses</div></div>
          <div id="logged-user" class="muted" style="font-size:13px"></div>
        </div>

        <div style="margin-bottom:8px">
          <div class="form-grid">
            <div>
              <label>Type</label>
              <select id="tx-type">
                <option value="Expense">Expense</option>
                <option value="Income">Income</option>
              </select>
            </div>
            <div>
              <label>Category</label>
              <select id="tx-category">
                <option>Food</option><option>Transport</option><option>Rent</option><option>Bills</option>
                <option>Groceries</option><option>Entertainment</option><option>Salary</option><option>Other</option>
              </select>
            </div>

            <div>
              <label>Amount</label>
              <input id="tx-amount" type="number" step="0.01" placeholder="0.00">
            </div>
            <div>
              <label>Date</label>
              <input id="tx-date" type="date">
            </div>

            <div style="grid-column: 1 / -1">
              <label>Notes</label>
              <textarea id="tx-notes" placeholder="Optional note (e.g., dinner with friends)"></textarea>
            </div>

            <div>
              <label>Recurring</label>
              <select id="tx-recurring">
                <option value="none">None</option>
                <option value="monthly">Monthly</option>
              </select>
            </div>

            <div style="display:flex;align-items:center;gap:8px">
              <button id="btn-save" class="btn btn-primary">Add</button>
              <button id="btn-cancel" class="btn btn-ghost">Clear</button>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:6px;align-items:center">
          <button id="btn-export-csv" class="btn small">Export CSV</button>
          <button id="btn-export-json" class="btn small">Export JSON</button>
          <label for="import-file" class="btn small btn-ghost" style="cursor:pointer">Import JSON</label>
          <input id="import-file" type="file" accept="application/json" style="display:none">
          <button id="btn-clear-all" class="btn small" style="margin-left:auto;background:#fee2e2;color:#b91c1c">Clear All</button>
        </div>
      </div>

      <!-- Summary -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>Overview</strong>
          <div class="muted">This month</div>
        </div>
        <div class="summary">
          <div class="stat">
            <div class="icon" style="background:linear-gradient(90deg,#0288d1,#4db6ac)"><i class="fa-solid fa-wallet"></i></div>
            <div>
              <div class="num" id="sum-balance">0.00</div>
              <div class="lbl">Balance</div>
            </div>
          </div>

          <div class="stat">
            <div class="icon" style="background:linear-gradient(90deg,#43a047,#66bb6a)"><i class="fa-solid fa-coins"></i></div>
            <div>
              <div class="num" id="sum-income">0.00</div>
              <div class="lbl">Income</div>
            </div>
          </div>

          <div class="stat">
            <div class="icon" style="background:linear-gradient(90deg,#f59e0b,#f97316)"><i class="fa-solid fa-credit-card"></i></div>
            <div>
              <div class="num" id="sum-expense">0.00</div>
              <div class="lbl">Expense</div>
            </div>
          </div>

          <div class="stat">
            <div class="icon" style="background:linear-gradient(90deg,#ef4444,#ef6c6c)"><i class="fa-solid fa-bullseye"></i></div>
            <div>
              <div class="num muted" id="budget-amount">0.00</div>
              <div class="lbl">Monthly Budget</div>
            </div>
          </div>
        </div>

        <div style="margin-top:10px">
          <label style="font-size:12px;color:var(--muted)">Set monthly budget</label>
          <div style="display:flex;gap:8px;margin-top:6px">
            <input id="budget-input" type="number" placeholder="e.g., 15000" style="flex:1">
            <button id="btn-budget-set" class="btn btn-primary">Set</button>
          </div>
          <div style="margin-top:8px">
            <div class="progress"><div id="budget-bar" class="bar" style="width:0%"></div></div>
            <div style="display:flex;justify-content:space-between;margin-top:6px">
              <div class="muted small">Used</div>
              <div id="budget-used" class="muted small">0%</div>
            </div>
          </div>
        </div>

      </div>

      <!-- Filters + Search -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>Search & Filter</strong>
          <div class="muted small">Refine results</div>
        </div>

        <div class="filters" style="margin-bottom:8px">
          <input id="search-input" type="search" placeholder="Search description or category...">
          <select id="filter-type">
            <option value="all">All</option>
            <option value="Expense">Expense</option>
            <option value="Income">Income</option>
          </select>
          <select id="filter-category">
            <option value="all">All categories</option>
            <option>Food</option><option>Transport</option><option>Rent</option><option>Bills</option>
            <option>Groceries</option><option>Entertainment</option><option>Salary</option><option>Other</option>
          </select>
          <input id="filter-start" type="date">
          <input id="filter-end" type="date">
          <button id="btn-filter-apply" class="btn small btn-primary">Apply</button>
          <button id="btn-filter-clear" class="btn small btn-ghost">Clear</button>
        </div>

      </div>
    </div>

    <!-- right -->
    <div class="dashboard">
      <div class="card charts">
        <div style="padding:6px">
          <strong>Charts</strong>
          <div class="muted small">Spending breakdown & monthly trend</div>
          <div style="height:12px"></div>
          <canvas id="lineChart" style="background:transparent;margin-bottom:6px"></canvas>
        </div>

        <div style="padding:6px">
          <canvas id="pieChart" width="420" height="300"></canvas>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>Recent Transactions</strong>
          <div class="muted small">Latest 10</div>
        </div>

        <div id="recent-list"></div>

        <table class="table" style="margin-top:8px">
          <thead><tr><th>Category</th><th>Notes</th><th>Amount</th><th>Date</th><th>Action</th></tr></thead>
          <tbody id="txn-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Login modal -->
  <div id="login-modal" class="modal" style="display:none">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <strong>Sign in / Sign up</strong>
        <div class="muted small">Local demo auth</div>
      </div>
      <div style="margin-bottom:8px">
        <label>Username</label>
        <input id="auth-username" type="text" placeholder="choose a username">
      </div>
      <div style="margin-bottom:12px">
        <label>Password</label>
        <input id="auth-password" type="password" placeholder="password (stored locally)">
      </div>
      <div style="display:flex;gap:8px">
        <button id="btn-signup" class="btn btn-primary">Sign up</button>
        <button id="btn-login" class="btn btn-ghost">Log in</button>
      </div>
      <div class="muted small" style="margin-top:10px">
        Note: This demo stores credentials in browser localStorage (not secure) — use only for testing.
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
  
/* -------------------------
   Utilities & Data storage
   ------------------------- */

const USER_KEY = 'ex_users_v1';            // stores users: {username: password}
const SESSION_KEY = 'ex_session_v1';       // stores current logged username
const DATA_PREFIX = 'ex_data_v1_';         // per-user data key: DATA_PREFIX + username

/* DOM elements */
const btnTheme = document.getElementById('btn-theme');
const userArea = document.getElementById('user-area');
const loginModal = document.getElementById('login-modal');
const authUser = document.getElementById('auth-username');
const authPass = document.getElementById('auth-password');
const btnSignup = document.getElementById('btn-signup');
const btnLogin = document.getElementById('btn-login');

const txType = document.getElementById('tx-type');
const txCategory = document.getElementById('tx-category');
const txAmount = document.getElementById('tx-amount');
const txDate = document.getElementById('tx-date');
const txNotes = document.getElementById('tx-notes');
const txRecurring = document.getElementById('tx-recurring');
const btnSave = document.getElementById('btn-save');
const btnCancel = document.getElementById('btn-cancel');
const btnExportCSV = document.getElementById('btn-export-csv');
const btnExportJSON = document.getElementById('btn-export-json');
const importFile = document.getElementById('import-file');
const btnClearAll = document.getElementById('btn-clear-all');

const summaryBalance = document.getElementById('sum-balance');
const summaryIncome = document.getElementById('sum-income');
const summaryExpense = document.getElementById('sum-expense');
const budgetAmountEl = document.getElementById('budget-amount');
const budgetInput = document.getElementById('budget-input');
const btnBudgetSet = document.getElementById('btn-budget-set');
const budgetBar = document.getElementById('budget-bar');
const budgetUsed = document.getElementById('budget-used');

const searchInput = document.getElementById('search-input');
const filterType = document.getElementById('filter-type');
const filterCategory = document.getElementById('filter-category');
const filterStart = document.getElementById('filter-start');
const filterEnd = document.getElementById('filter-end');
const btnFilterApply = document.getElementById('btn-filter-apply');
const btnFilterClear = document.getElementById('btn-filter-clear');

const recentList = document.getElementById('recent-list');
const txnTableBody = document.getElementById('txn-table-body');

const toastEl = document.getElementById('toast');

let lineChart = null, pieChart = null;

/* Per-user runtime state */
let currentUser = null;
let store = {
  expenses: [],           // all transactions for user
  templates: [],          // recurring templates
  settings: {budget: 0}   // budget etc
};
let editingId = null;

/* Helpers */
function toast(msg, time=2200){
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'), time);
}

function uid(prefix='id'){
  return prefix + '_' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
}

function todayISO(){
  const d = new Date();
  const iso = d.toISOString().slice(0,10);
  return iso;
}

function monthKeyFromDateString(s){ // s as YYYY-MM-DD
  if(!s) return null;
  return s.slice(0,7); // YYYY-MM
}

function clamp(n,min,max){return Math.max(min,Math.min(max,n));}

/* -------------------------
   Authentication (localStorage)
   ------------------------- */
function loadUsers(){ try { return JSON.parse(localStorage.getItem(USER_KEY) || '{}'); } catch(e){ return {}; } }
function saveUsers(u){ localStorage.setItem(USER_KEY, JSON.stringify(u)); }

function showLogin(show=true){
  loginModal.style.display = show ? 'flex' : 'none';
  if(show){ authUser.value=''; authPass.value=''; }
}

function setSession(username){
  localStorage.setItem(SESSION_KEY, username);
  currentUser = username;
  loadUserData();
  renderUserArea();
}

function clearSession(){
  localStorage.removeItem(SESSION_KEY);
  currentUser = null;
  store = {expenses:[],templates:[],settings:{budget:0}};
  renderUserArea();
  showLogin(true);
}

/* sign up logic */
btnSignup.addEventListener('click', ()=>{
  const u = (authUser.value || '').trim();
  const p = (authPass.value || '').trim();
  if(!u || !p){ toast('Enter username & password'); return; }
  const users = loadUsers();
  if(users[u]){ toast('Username already exists'); return; }
  users[u] = p;
  saveUsers(users);
  toast('Account created. Logged in.');
  setSession(u);
  showLogin(false);
});

/* login */
btnLogin.addEventListener('click', ()=>{
  const u = (authUser.value || '').trim();
  const p = (authPass.value || '').trim();
  if(!u || !p){ toast('Enter username & password'); return; }
  const users = loadUsers();
  if(users[u] && users[u] === p){
    toast('Logged in');
    setSession(u);
    showLogin(false);
  } else {
    toast('Invalid credentials');
  }
});

/* show user area (login/logout) */
function renderUserArea(){
  const s = localStorage.getItem(SESSION_KEY);
  currentUser = s || currentUser;
  if(currentUser){
    userArea.innerHTML = `<div style="display:flex;align-items:center;gap:8px">
      <div style="font-weight:700">${currentUser}</div>
      <button id="btn-logout" class="btn small btn-ghost">Logout</button>
    </div>`;
    document.getElementById('btn-logout').addEventListener('click', ()=>{ clearSession(); toast('Logged out'); });
  } else {
    userArea.innerHTML = `<button id="btn-open-login" class="btn small btn-primary">Login / Sign up</button>`;
    document.getElementById('btn-open-login').addEventListener('click', ()=> showLogin(true));
    showLogin(true);
  }
}

/* -------------------------
   Data persistence per user
   ------------------------- */
function userDataKey(username){ return DATA_PREFIX + username; }

function loadUserData(){
  if(!currentUser) return;
  try {
    const raw = localStorage.getItem(userDataKey(currentUser));
    const d = raw ? JSON.parse(raw) : null;
    if(d && typeof d === 'object'){
      store = {
        expenses: Array.isArray(d.expenses) ? d.expenses : [],
        templates: Array.isArray(d.templates) ? d.templates : [],
        settings: d.settings || {budget:0}
      };
    } else {
      store = {expenses:[], templates:[], settings:{budget:0}};
    }
  } catch(e){
    store = {expenses:[], templates:[], settings:{budget:0}};
  }
  // ensure proper types
  store.expenses = store.expenses.map(e => ({...e, amount: Number(e.amount)}));
  processRecurringTemplates(); // create monthly generated txns
  persist();
  renderAll();
}

function persist(){
  if(!currentUser) return;
  localStorage.setItem(userDataKey(currentUser), JSON.stringify(store));
}

/* -------------------------
   Recurring templates -> generate current month's transactions
   Templates are stored separately and have id
   For each template, we generate a transaction per calendar month if not yet created
   Generated transactions reference templateId so we don't duplicate
   ------------------------- */
function processRecurringTemplates(){
  const nowMonth = (new Date()).toISOString().slice(0,7); // YYYY-MM
  const toAdd = [];
  store.templates.forEach(t => {
    if(t.recurrence === 'monthly'){
      // Check whether a txn was already created for this template this month
      const exists = store.expenses.some(e => e.templateId === t.id && monthKeyFromDateString(e.date) === nowMonth);
      if(!exists){
        // create a transaction for this month
        const day = t.startDay || t.date?.slice(8,10) || (new Date()).toISOString().slice(8,10);
        const year = nowMonth.slice(0,4);
        const month = nowMonth.slice(5,7);
        let dayNum = parseInt(day,10);
        // if dayNum is invalid, set to 1
        if(isNaN(dayNum) || dayNum < 1) dayNum = 1;
        // ensure valid day for month
        const d = new Date(year, parseInt(month,10)-1, dayNum);
        const genDate = d.toISOString().slice(0,10);
        const newTxn = {
          id: uid('txn'),
          templateId: t.id,
          category: t.category,
          type: t.type,
          amount: Number(t.amount),
          date: genDate,
          notes: t.notes || `Recurring: ${t.recurrence}`,
          createdFromTemplate: true
        };
        toAdd.push(newTxn);
      }
    }
  });
  if(toAdd.length){
    store.expenses.push(...toAdd);
    // persist is handled by caller
  }
}

/* -------------------------
   Add / Edit / Delete transactions
   ------------------------- */
function addTransactionFromForm(){
  const type = txType.value;
  const category = txCategory.value;
  const amount = Number(txAmount.value);
  const date = txDate.value;
  const notes = txNotes.value.trim();
  const recurrence = txRecurring.value;

  if(!amount || amount <= 0 || !date || !category){
    toast('Please enter valid amount, date and category');
    return;
  }

  if(editingId){
    const idx = store.expenses.findIndex(e => e.id === editingId);
    if(idx !== -1){
      store.expenses[idx] = {...store.expenses[idx], type, category, amount: Number(amount), date, notes};
      toast('Updated transaction');
    }
    // editing templates also? not in this simple flow
    editingId = null;
    document.getElementById('form-title').textContent = 'Add Transaction';
    btnSave.textContent = 'Add';
  } else {
    const txn = {
      id: uid('txn'),
      category, type, amount: Number(amount),
      date, notes
    };
    store.expenses.push(txn);
    toast('Added transaction');
    // if recurrence selected, create a template
    if(recurrence !== 'none'){
      const tpl = {
        id: uid('tpl'),
        category, type, amount: Number(amount),
        recurrence, startDay: Number(date.slice(8,10)), date, notes
      };
      store.templates.push(tpl);
      toast('Recurring template created (monthly)');
    }
  }

  persist();
  renderAll();
  clearForm();
}

function clearForm(){
  txAmount.value = '';
  txDate.value = todayISO();
  txNotes.value = '';
  txRecurring.value = 'none';
  txCategory.selectedIndex = 0;
  txType.value = 'Expense';
  editingId = null;
  document.getElementById('form-title').textContent = 'Add Transaction';
  btnSave.textContent = 'Add';
}

function startEdit(id){
  const t = store.expenses.find(x => x.id === id);
  if(!t) return;
  editingId = id;
  txType.value = t.type || 'Expense';
  txCategory.value = t.category || '';
  txAmount.value = t.amount;
  txDate.value = t.date;
  txNotes.value = t.notes || '';
  document.getElementById('form-title').textContent = 'Edit Transaction';
  btnSave.textContent = 'Save';
}

/* Delete */
function deleteTxn(id){
  if(!confirm('Delete this transaction?')) return;
  store.expenses = store.expenses.filter(e => e.id !== id);
  persist();
  renderAll();
  toast('Deleted');
}

/* Clear all */
btnClearAll.addEventListener('click', ()=>{
  if(!currentUser) return toast('Login first');
  if(!confirm('Delete ALL transactions and templates?')) return;
  store.expenses = [];
  store.templates = [];
  persist();
  renderAll();
  toast('All cleared');
});

/* -------------------------
   Filters / Search
   ------------------------- */

function getFilteredTransactions(){
  let list = [...store.expenses];
  // Date range
  const start = filterStart.value || null;
  const end = filterEnd.value || null;
  if(start){
    const s = new Date(start);
    list = list.filter(e => new Date(e.date) >= s);
  }
  if(end){
    const eDate = new Date(end); eDate.setHours(23,59,59,999);
    list = list.filter(e => new Date(e.date) <= eDate);
  }
  // Type
  const type = filterType.value;
  if(type && type !== 'all') list = list.filter(e => e.type === type);
  // Category
  const cat = filterCategory.value;
  if(cat && cat !== 'all') list = list.filter(e => e.category === cat);
  // Search
  const q = (searchInput.value || '').trim().toLowerCase();
  if(q){
    list = list.filter(e => (e.notes||'').toLowerCase().includes(q) || (e.category||'').toLowerCase().includes(q));
  }
  // Sort descending date
  list.sort((a,b) => new Date(b.date) - new Date(a.date) || b.id.localeCompare(a.id));
  return list;
}

/* -------------------------
   Charts & rendering
   ------------------------- */
function formatMoney(n){ return Number(n).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); }

function renderAll(){
  // Summary for current month
  const now = new Date();
  const curMonthKey = now.toISOString().slice(0,7);
  let income = 0, expense = 0;
  store.expenses.forEach(e => {
    if(monthKeyFromDateString(e.date) === curMonthKey){
      if(e.type === 'Income') income += Number(e.amount);
      else expense += Number(e.amount);
    }
  });
  const balance = income - expense;
  summaryIncome.textContent = '₹' + formatMoney(income);
  summaryExpense.textContent = '₹' + formatMoney(expense);
  summaryBalance.textContent = '₹' + formatMoney(balance);

  // budget
  const budget = Number(store.settings?.budget || 0);
  budgetAmountEl.textContent = budget ? '₹' + formatMoney(budget) : '₹0.00';
  const usedPercent = budget ? Math.round((expense / budget) * 100) : 0;
  const clamped = clamp(usedPercent, 0, 999);
  budgetBar.style.width = (clamped > 100 ? 100 : clamped) + '%';
  budgetUsed.textContent = (clamped > 100 ? '>100' : clamped) + '%';

  // show alerts for budget
  if(budget > 0 && usedPercent >= 100){
    toast('Budget exceeded for this month!', 3500);
  } else if(budget > 0 && usedPercent >= 80){
    toast('Budget usage at 80%+', 2500);
  }

  renderRecent();
  renderTable();
  renderCharts();
}

/* Recent list (latest 10 from filtered or all) */
function renderRecent(){
  const filtered = getFilteredTransactions();
  const recent = filtered.slice(0,10);
  recentList.innerHTML = '';
  recent.forEach(tx => {
    const div = document.createElement('div');
    div.className = 'recent-item';
    div.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <div style="width:44px;height:44;border-radius:10px;display:flex;align-items:center;justify-content:center;background:${tx.type === 'Income' ? '#dff7e4' : '#ffeaea'}">
          <div style="font-weight:700">${tx.category[0] || 'C'}</div>
        </div>
        <div>
          <div style="font-weight:600">${tx.category} <span class="muted small">· ${tx.notes || ''}</span></div>
          <div class="muted small">${new Date(tx.date).toLocaleDateString()}</div>
        </div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700;color:${tx.type === 'Income' ? '#0f5132' : '#b91c1c'}">₹${formatMoney(tx.amount)}</div>
        <div class="txn-actions" style="margin-top:6px">
          <button class="btn small btn-ghost" onclick="startEdit('${tx.id}')">Edit</button>
          <button class="btn small" style="background:#fee2e2;color:#b91c1c" onclick="deleteTxn('${tx.id}')">Delete</button>
        </div>
      </div>
    `;
    recentList.appendChild(div);
  });
}

/* Table of transactions (filtered) */
function renderTable(){
  const list = getFilteredTransactions();
  txnTableBody.innerHTML = '';
  list.forEach(tx => {
    const tr = document.createElement('tr'); tr.className = 'txn-row';
    const catTd = document.createElement('td'); catTd.innerHTML = `<span class="badge" style="background:${tx.type==='Income'?'#dff7e4':'#ffeaea'};padding:6px;border-radius:8px">${tx.category}</span>`;
    const notesTd = document.createElement('td'); notesTd.textContent = tx.notes || '';
    const amtTd = document.createElement('td'); amtTd.innerHTML = `<strong style="color:${tx.type==='Income'?'#0f5132':'#b91c1c'}">₹${formatMoney(tx.amount)}</strong>`;
    const dateTd = document.createElement('td'); dateTd.textContent = new Date(tx.date).toLocaleDateString();
    const actTd = document.createElement('td'); actTd.innerHTML = `
      <button class="btn small btn-ghost" onclick="startEdit('${tx.id}')"><i class="fa-regular fa-pen-to-square"></i></button>
      <button class="btn small" style="background:#fee2e2;color:#b91c1c" onclick="deleteTxn('${tx.id}')"><i class="fa-regular fa-trash-can"></i></button>
    `;
    tr.appendChild(catTd); tr.appendChild(notesTd); tr.appendChild(amtTd); tr.appendChild(dateTd); tr.appendChild(actTd);
    txnTableBody.appendChild(tr);
  });
}

/* Charts */
function renderCharts(){
  // Pie chart: categories (Expense only) using currently filtered txns
  const filtered = getFilteredTransactions();
  const expenseByCat = {};
  filtered.forEach(t => {
    if(t.type === 'Expense'){
      expenseByCat[t.category] = (expenseByCat[t.category] || 0) + Number(t.amount);
    }
  });
  const pieLabels = Object.keys(expenseByCat);
  const pieData = pieLabels.map(l => expenseByCat[l]);

  // destroy old
  if(pieChart){ pieChart.destroy(); pieChart = null; }
  const pieCtx = document.getElementById('pieChart').getContext('2d');
  if(pieLabels.length){
    pieChart = new Chart(pieCtx, {
      type: 'pie',
      data: { labels: pieLabels, datasets: [{ data: pieData, backgroundColor: generatePalette(pieLabels.length) }] },
      options: { plugins:{legend:{position:'right'}} }
    });
  } else {
    // draw empty message
    pieCtx.clearRect(0,0,420,300);
    pieCtx.font = '14px Inter';
    pieCtx.fillStyle = '#94a3b8';
    pieCtx.fillText('No expense data to display (select filters/add expenses).', 12, 140);
  }

  // Line chart: monthly trend (last 6 months)
  const months = lastNMonthKeys(6); // ['2025-04', ...]
  const incomeSeries = [], expenseSeries = [];
  months.forEach(mk => {
    let inc = 0, exp = 0;
    store.expenses.forEach(e => {
      if(monthKeyFromDateString(e.date) === mk){
        if(e.type === 'Income') inc += Number(e.amount);
        else exp += Number(e.amount);
      }
    });
    incomeSeries.push(inc); expenseSeries.push(exp);
  });

  if(lineChart) { lineChart.destroy(); lineChart = null; }
  const lineCtx = document.getElementById('lineChart').getContext('2d');
  lineChart = new Chart(lineCtx, {
    type: 'line',
    data: {
      labels: months.map(k => {
        const [y,m] = k.split('-'); return new Date(y, m-1, 1).toLocaleString(undefined,{month:'short',year:'numeric'});
      }),
      datasets: [
        { label:'Income', data: incomeSeries, fill:false, borderColor:'#43a047', tension:0.25 },
        { label:'Expense', data: expenseSeries, fill:false, borderColor:'#ef4444', tension:0.25 }
      ]
    },
    options: { plugins:{legend:{position:'top'}} }
  });
}

/* -------------------------
   Exports / Import
   ------------------------- */
function exportCSV(){
  const list = store.expenses.map(e => ({
    id: e.id, date: e.date, type: e.type, category: e.category, amount: e.amount, notes: e.notes || '', templateId: e.templateId || ''
  }));
  const header = ['id','date','type','category','amount','notes','templateId'];
  const rows = [header.join(',')].concat(list.map(r => header.map(h => JSON.stringify(r[h] ?? '')).join(',')));
  const blob = new Blob([rows.join('\\n')], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (currentUser||'data') + '_transactions.csv'; a.click();
}

function exportJSON(){
  const data = {expenses: store.expenses, templates: store.templates, settings: store.settings};
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (currentUser||'data') + '_export.json'; a.click();
}

importFile.addEventListener('change', (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = (e)=>{
    try {
      const parsed = JSON.parse(e.target.result);
      if(parsed.expenses && Array.isArray(parsed.expenses)){
        // append imported txns (avoid duplicates by id)
        const existingIds = new Set(store.expenses.map(x => x.id));
        const toAdd = parsed.expenses.filter(x => !existingIds.has(x.id)).map(x => ({...x, amount: Number(x.amount)}));
        store.expenses.push(...toAdd);
        // optional: import templates & settings
        if(parsed.templates && Array.isArray(parsed.templates)) {
          const existTplIds = new Set(store.templates.map(t=>t.id));
          const newTpls = parsed.templates.filter(t => !existTplIds.has(t.id));
          store.templates.push(...newTpls);
        }
        if(parsed.settings) store.settings = parsed.settings;
        persist();
        renderAll();
        toast('Imported ' + toAdd.length + ' transactions');
      } else {
        toast('Invalid JSON structure');
      }
    } catch(err){
      toast('Failed to parse file');
    }
  };
  reader.readAsText(f);
});

/* -------------------------
   Budget management
   ------------------------- */
btnBudgetSet.addEventListener('click', ()=>{
  const v = Number(budgetInput.value);
  if(!v || v <= 0){ toast('Enter a valid budget'); return; }
  store.settings.budget = Number(v);
  persist();
  renderAll();
  toast('Budget updated');
});

/* -------------------------
   Helpers & small util functions
   ------------------------- */
function lastNMonthKeys(n){
  const out = [];
  const now = new Date();
  for(let i = n-1; i >= 0; i--){
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const k = d.toISOString().slice(0,7);
    out.push(k);
  }
  return out;
}

function generatePalette(n){
  const base = ['#0288d1','#4db6ac','#ef4444','#f59e0b','#8e24aa','#43a047','#c2185b','#6d4c41','#00bcd4','#ff7043'];
  if(n <= base.length) return base.slice(0,n);
  const out = [];
  for(let i=0;i<n;i++){
    const h = Math.floor(360 * (i/n));
    out.push('hsl('+h+',70%,50%)');
  }
  return out;
}

/* -------------------------
   Bindings & initialization
   ------------------------- */
btnTheme.addEventListener('click', ()=>{
  document.body.classList.toggle('dark');
  // simple visual change by toggling class (CSS not fully themed here)
  btnTheme.textContent = document.body.classList.contains('dark') ? 'Light' : 'Theme';
});

/* Save / Add */
btnSave.addEventListener('click', addTransactionFromForm);
btnCancel.addEventListener('click', clearForm);

/* Filters */
btnFilterApply.addEventListener('click', ()=>{ renderAll(); toast('Filter applied',1200); });
btnFilterClear.addEventListener('click', ()=>{
  searchInput.value=''; filterType.value='all'; filterCategory.value='all'; filterStart.value=''; filterEnd.value='';
  renderAll(); toast('Filters cleared',1200);
});

/* Exports */
btnExportCSV.addEventListener('click', exportCSV);
btnExportJSON.addEventListener('click', exportJSON);

/* Start defaults */
document.addEventListener('DOMContentLoaded', ()=>{
  // set today's date in form & filter defaults
  txDate.value = todayISO();
  filterEnd.value = todayISO();

  // check session
  const sess = localStorage.getItem(SESSION_KEY);
  if(sess){
    setSession(sess);
    showLogin(false);
  } else {
    renderUserArea();
  }

  // wire global functions to window for inline onclicks in dynamic content
  window.startEdit = startEdit;
  window.deleteTxn = deleteTxn;
});

/* -------------------------
   Init render after login / loadUserData
   ------------------------- */

function renderAfterLogin(){
  // show logged user somewhere
  document.getElementById('logged-user').textContent = currentUser ? ('User: ' + currentUser) : '';
  // load user data and render
  loadUserData();
}

/* expose for setSession */
window.setSession = function(u){
  localStorage.setItem(SESSION_KEY, u);
  setSession(u);
  showLogin(false);
  renderUserArea();
  loadUserData();
};

/* ensure that setSession called on initial DOM load triggers rendering */
renderUserArea();

</script>
</body>
</html>
